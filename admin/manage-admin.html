<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abhishek Rubber Products</title>

     <link rel="shortcut icon" href="/img/logo/favicon.ico" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f3f4f6;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #ffffff;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            border-right: 1px solid #e5e5e5;
            padding: 20px 0;
        }

        .sidebar .nav-link {
            font-size: 16px;
            color: #333;
            padding: 12px 25px;
            margin: 4px 0;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: #ef7f1a;
            color: #fff;
        }

        /* Content area */
        .content {
            margin-left: 260px;
            padding: 30px;
        }

        .card-box {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.07);
        }

        .btn-orange {
            background: #ef7f1a;
            color: #fff;
            font-weight: 600;
        }

        .btn-orange:hover {
            background: #d36f12;
        }
    </style>
</head>

<body>
<!-- Sidebar -->
    <div class="sidebar">
       <a href="index.html" class="navbar-brand " style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
                    <img src="/img/logo/Abhishek Rubber Product.png" height="50" alt="">
                </a>

        <nav class="nav flex-column">
            <a class="nav-link " href="/admin/admin-dashboard.html">Dashboard</a>
            <a class="nav-link active" href="/admin/manage-admin.html">Manage Admins</a>
            <a class="nav-link" href="/admin/manage-products.html">Manage Products</a>
            <a class="nav-link" href="/admin/manage-gallery.html">Manage Gallery</a>
            <a class="nav-link text-danger" id="logout" href="login.html">Logout</a>
        </nav>
    </div>


    <!-- MAIN CONTENT -->
    <div class="content">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>Manage Admins</h3>
            <button class="btn btn-orange" data-bs-toggle="modal" data-bs-target="#addAdminModal">Add New Admin</button>
        </div>

        <!-- Table -->
        <div class="card-box">

            <h5 class="mb-3">Admin List</h5>

            <div class="table-responsive">
                <table class="table table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th width="150">Actions</th>
                        </tr>
                    </thead>

                    <tbody id="admin-list-body">
                        <!-- Example Admin -->
                        <tr>
                            <td>Super Admin</td>
                            <td>admin@example.com</td>
                            <td>
                                <button class="btn btn-danger btn-sm">Delete</button>
                            </td>
                        </tr>

                        <!-- More admins will come dynamically -->
                    </tbody>

                </table>
            </div>

        </div>

    </div>


    <!-- ADD ADMIN MODAL -->
    <div class="modal fade" id="addAdminModal">
        <div class="modal-dialog">
            <div class="modal-content p-3">

                <div class="modal-header">
                    <h5 class="modal-title">Add New Admin</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <form id="add-admin-form">
                    <div class="modal-body">

                        <div id="add-admin-message" class="mb-3" aria-live="polite"></div>

                        <label class="form-label fw-bold">Full Name</label>
                        <input id="add-admin-fullname" name="fullName" type="text" class="form-control mb-3" placeholder="Enter admin name" required>

                        <label class="form-label fw-bold">Email</label>
                        <input id="add-admin-email" name="email" type="email" class="form-control mb-3" placeholder="Enter admin email" required>

                        <label class="form-label fw-bold">Password</label>
                        <input id="add-admin-password" name="password" type="password" class="form-control mb-3" placeholder="Enter password" required>

                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button id="add-admin-submit" type="submit" class="btn btn-orange">Add Admin</button>
                    </div>

                </form>

            </div>
        </div>
    </div>


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { BASEURL } from '../BASEURL.js';

        (async function() {
            function escapeHtml(s){ return String(s||'').replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
            try {
                const token = localStorage.getItem('adminToken');
                if (!token) { window.location.href = 'login.html'; return; }

                const tbody = document.getElementById('admin-list-body');
                if (!tbody) return;
                tbody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';

                const res = await fetch(`${BASEURL}/all`, {
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }
                });
                let json = {};
                try { json = await res.json(); } catch(e) { json = {}; }

                tbody.innerHTML = '';

                if (res.ok && json && Array.isArray(json.data) && json.data.length) {
                    json.data.forEach(admin => {
                        const tr = document.createElement('tr');
                        const name = admin.fullName || (admin.createdBy && admin.createdBy.name) || admin.email || '';
                        tr.innerHTML = `
                            <td>${escapeHtml(name)}</td>
                            <td>${escapeHtml(admin.email || '')}</td>
                            <td>
                                <button class="btn btn-danger btn-sm" data-id="${escapeHtml(admin._id || '')}">Delete</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="3">No admins found</td></tr>';
                }

                tbody.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button[data-id]');
                    if (!btn) return;
                    const id = btn.getAttribute('data-id');
                    if (!id) return;
                    if (!confirm('Are you sure you want to delete this admin?')) return;
                    try {
                        const dRes = await fetch(`${BASEURL}/${id}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
                        if (dRes.ok) { btn.closest('tr').remove(); }
                        else { alert('Failed to delete admin.'); }
                    } catch (err) { alert('Network error.'); }
                });

                // Add admin form handling
                const addForm = document.getElementById('add-admin-form');
                const addMessage = document.getElementById('add-admin-message');
                if (addForm) {
                    addForm.addEventListener('submit', async (ev) => {
                        ev.preventDefault();
                        const submitBtn = document.getElementById('add-admin-submit');
                        const fullName = (addForm.elements['fullName'] || {}).value || '';
                        const email = (addForm.elements['email'] || {}).value || '';
                        const password = (addForm.elements['password'] || {}).value || '';
                        if (!fullName.trim() || !email.trim() || !password) {
                            if (addMessage) { addMessage.textContent = 'Please fill all fields.'; addMessage.className = 'text-danger small'; }
                            return;
                        }
                        submitBtn.disabled = true;
                        const originalText = submitBtn.textContent;
                        submitBtn.textContent = 'Creating...';
                        if (addMessage) { addMessage.textContent = ''; addMessage.className = ''; }
                        try {
                            const pRes = await fetch(`${BASEURL}/api/admin/register`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                                body: JSON.stringify({ fullName: fullName.trim(), email: email.trim(), password: password })
                            });
                            let pJson = {};
                            try { pJson = await pRes.json(); } catch (e) { pJson = {}; }
                            if (pRes.ok && pJson && (pJson.success || pJson.data)) {
                                const admin = pJson.data || pJson;
                                const tr = document.createElement('tr');
                                const name = admin.fullName || (admin.createdBy && admin.createdBy.name) || admin.email || '';
                                tr.innerHTML = `
                                    <td>${escapeHtml(name)}</td>
                                    <td>${escapeHtml(admin.email || '')}</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" data-id="${escapeHtml(admin._id || '')}">Delete</button>
                                    </td>
                                `;
                                tbody.insertBefore(tr, tbody.firstChild);
                                if (addMessage) { addMessage.textContent = 'Admin created.'; addMessage.className = 'text-success small'; }
                                addForm.reset();
                                try { const modalInst = bootstrap.Modal.getInstance(document.getElementById('addAdminModal')); if (modalInst) modalInst.hide(); } catch (_) {}
                                setTimeout(() => { window.location.reload(); }, 300);
                            } else {
                                const err = (pJson && (pJson.message || pJson.error)) || 'Failed to create admin.';
                                if (addMessage) { addMessage.textContent = err; addMessage.className = 'text-danger small'; }
                            }
                        } catch (err) {
                            if (addMessage) { addMessage.textContent = 'Network error.'; addMessage.className = 'text-danger small'; }
                        } finally {
                            submitBtn.disabled = false; submitBtn.textContent = originalText;
                        }
                    });
                }

                const logoutLink = document.getElementById('logout');
                if (logoutLink) {
                    logoutLink.addEventListener('click', (ev) => { ev.preventDefault(); localStorage.removeItem('adminToken'); window.location.href = 'login.html'; });
                }
            } catch (err) {
                console.error(err);
            }
        })();
    </script>
</body>
</html>
